<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Orbital Explorer | NASA Terminal v8.9 Gold</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;900&display=swap');

        html, body {
            margin: 0; padding: 0; height: 100%;
            background-color: #000; color: white;
            cursor: none; overflow-x: hidden;
            font-family: 'Inter', sans-serif;
        }

        /* ЭФФЕКТ ГЛИТЧА */
        .glitch-active #grid-container {
            animation: shake 0.2s infinite;
            filter: hue-rotate(90deg) contrast(1.5);
        }
        @keyframes shake {
            0% { transform: translate(0,0); }
            25% { transform: translate(5px, -5px); }
            50% { transform: translate(-5px, 5px); }
            75% { transform: translate(2px, -2px); }
            100% { transform: translate(0,0); }
        }

        /* HUD ПАНЕЛЬ */
        #top-hud {
            position: fixed; top: 0; left: 0; width: 100%;
            height: 60px; z-index: 1000;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; font-family: monospace;
        }

        .hud-item { font-size: 9px; color: #60a5fa; letter-spacing: 1px; }

        /* УВЕДОМЛЕНИЯ */
        #alert-container {
            position: fixed; top: 70px; right: 10px; z-index: 2000;
            display: flex; flex-direction: column; gap: 8px; pointer-events: none;
            max-width: 90vw;
        }
        .alert-box {
            background: rgba(5, 11, 28, 0.9); border-left: 3px solid #60a5fa;
            padding: 10px 15px; font-family: monospace; font-size: 10px;
            color: #60a5fa; backdrop-filter: blur(10px);
            animation: alert-in 0.5s ease-out forwards;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            line-height: 1.4;
        }
        @keyframes alert-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* СЕТКА ФОНА */
        #grid-container { position: fixed; inset: 0; z-index: 1; pointer-events: none; }
        #grid-overlay {
            position: absolute; inset: 0;
            background-image: 
                linear-gradient(rgba(59, 130, 246, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        /* 3D ОКНО */
        #space-view {
            position: fixed; inset: 0; z-index: 5000; display: none;
            background: #000;
        }
        #three-canvas { width: 100%; height: 100%; cursor: grab; }

        .telemetry-overlay {
            position: absolute; top: 80px; left: 20px; width: 280px;
            background: rgba(0, 20, 40, 0.6); border: 1px solid #3b82f6;
            padding: 15px; font-family: monospace; color: #60a5fa;
            pointer-events: none; backdrop-filter: blur(5px);
        }

        /* КАРТОЧКИ */
        .glass { 
            background: rgba(15, 15, 15, 0.6); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 30px;
            transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            cursor: pointer;
            position: relative;
            z-index: 10;
            overflow: hidden;
        }
        .glass:hover { 
            border-color: #3b82f6; 
            background: rgba(20, 30, 60, 0.4);
            transform: translateY(-5px) scale(1.02); 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), 0 0 20px rgba(59, 130, 246, 0.2);
        }

        /* КУРСОР (скрыт на мобильных) */
        #cursor { width: 20px; height: 20px; border: 2px solid #60a5fa; border-radius: 50%; position: fixed; pointer-events: none; z-index: 100000; transform: translate(-50%, -50%); transition: width 0.3s, height 0.3s; display: none; }
        #coords { position: fixed; font-size: 9px; font-family: monospace; color: #60a5fa; z-index: 100001; pointer-events: none; display: none; }
        
        #starfield { position: fixed; inset: 0; z-index: -1; background: #050b1c; }

        .card-img-container {
            height: 200px; width: 100%; border-radius: 20px;
            overflow: hidden; margin-bottom: 1.5rem; position: relative;
        }
        .card-img-container img {
            width: 100%; height: 100%; object-fit: cover;
            filter: brightness(0.7); transition: transform 0.8s ease;
        }
        .glass:hover img { transform: scale(1.1); filter: brightness(1); }

        /* ЭФФЕКТ EXPLORER */
        .clickable-word { 
            text-decoration: underline; 
            text-decoration-color: rgba(59, 130, 246, 0.3); 
            cursor: pointer; 
            transition: all 0.3s ease;
        }
        .clickable-word:hover {
            color: #60a5fa;
            text-shadow: 0 0 15px #3b82f6;
            text-decoration-color: #60a5fa;
        }

        /* СКАНЕР */
        .scanline {
            position: absolute; top: -10px; left: 0; width: 100%; height: 3px;
            background: rgba(96, 165, 250, 0.8);
            box-shadow: 0 0 15px rgba(96, 165, 250, 1);
            display: none; z-index: 20; pointer-events: none;
        }
        .glass:hover .scanline { display: block; animation: scan-anim 2s linear infinite; }
        @keyframes scan-anim {
            0% { top: -10px; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* ТЕРМИНАЛ */
        #cmd-terminal {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(0, 5, 15, 0.95); border-top: 1px solid rgba(59, 130, 246, 0.4);
            z-index: 4000; padding: 10px 20px; display: flex; align-items: center; gap: 8px;
            font-family: monospace; backdrop-filter: blur(10px);
        }
        #cmd-input {
            background: transparent; border: none; outline: none;
            color: #fff; width: 100%; font-size: 12px;
        }

        /* STAR MAP ТЕКСТОВАЯ */
        #star-map {
            position: fixed; inset: 0; z-index: 3000; display: none;
            background: #000; padding: 70px 20px 20px; overflow-y: auto;
        }
        .map-text-box {
            border: 1px solid #1e3a8a; background: rgba(30, 58, 138, 0.1);
            padding: 15px; border-radius: 8px; font-family: monospace;
        }

        /* МИНИ ИГРА */
        #game-container {
            position: fixed; inset: 0; z-index: 8000; display: none;
            background: #000; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px;
        }
        #game-canvas { 
            border: 2px solid #3b82f6; 
            background: #001;
            width: 100%;
            height: auto;
            max-width: 600px;
            aspect-ratio: 600 / 400;
        }

        /* МОБИЛЬНЫЕ КНОПКИ УПРАВЛЕНИЯ */
        .mobile-controls {
            display: none; /* по умолчанию скрыты, включаются медиа-запросом */
            position: fixed;
            bottom: 80px; /* выше кнопки Abort Mission */
            left: 0;
            width: 100%;
            justify-content: center;
            gap: 20px;
            z-index: 9000;
            pointer-events: none; /* чтобы клики проходили сквозь контейнер, но не сквозь кнопки */
        }
        .mobile-controls button {
            pointer-events: auto; /* кнопки кликабельны */
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: rgba(0, 10, 20, 0.8);
            border: 2px solid #3b82f6;
            color: #3b82f6;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            touch-action: manipulation;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(59,130,246,0.3);
            transition: all 0.1s ease;
        }
        .mobile-controls button:active {
            background: #3b82f6;
            color: black;
            transform: scale(1.1);
        }
        @media (max-width: 640px) {
            .mobile-controls { display: flex; }
        }

        /* МОБИЛЬНАЯ АДАПТАЦИЯ */
        @media (min-width: 640px) {
            #cursor, #coords { display: block; }
            .hud-item { font-size: 10px; }
        }

        @media (max-width: 640px) {
            #top-hud { padding: 0 10px; height: 50px; }
            .hud-item { font-size: 8px; }
            .glass { border-radius: 20px; }
            h1 { font-size: 3.5rem; }
            .telemetry-overlay { left: 10px; width: calc(100% - 20px); max-width: 280px; }
            #cmd-terminal { padding: 8px 12px; }
            #cmd-input { font-size: 11px; }
        }
    </style>
</head>
<body onclick="triggerGlitch()">

    <audio id="bg-music" loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" type="audio/mpeg">
    </audio>

    <header id="top-hud">
        <div class="hud-item flex items-center gap-2">
            <span class="w-2 h-2 bg-blue-500 rounded-full animate-ping"></span>
            SYSTEM: ONLINE | <button onclick="event.stopPropagation(); toggleAudio();" id="audio-btn" class="text-yellow-500 hover:text-white underline">[ INIT AUDIO ]</button>
        </div>
        <div class="hud-item flex gap-3">
            <span class="cursor-pointer hover:text-white" onclick="event.stopPropagation(); showStarMap();">[ STAR_MAP ]</span>
        </div>
        <div class="hud-item">MISSION: <span id="mission-clock">00:00:00</span></div>
    </header>

    <div id="grid-container"><div id="grid-overlay"></div></div>
    <div id="alert-container"></div>

    <div id="star-map" onclick="event.stopPropagation();">
        <div class="flex flex-wrap justify-between items-center mb-5 border-b border-blue-500 pb-3">
            <h2 class="text-xl sm:text-3xl font-black italic text-white">CONSTELLATION NAVIGATOR</h2>
            <button onclick="closeStarMap()" class="text-red-500 font-mono text-xs border border-red-500 px-3 py-1 hover:bg-red-500 hover:text-white">[ EXIT MAP ]</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="map-text-box">
                <h4 class="text-blue-400 font-bold text-lg mb-2">SECTOR: ORION</h4>
                <p class="text-xs text-gray-400 leading-relaxed">
                    [STATUS: ACTIVE]<br>
                    COORDS: 05h 35m / -05°<br>
                    OBJECTS: Betelgeuse, Rigel<br>
                    ANOMALY: High radiation detected in Nebula M42.
                </p>
            </div>
            <div class="map-text-box">
                <h4 class="text-blue-400 font-bold text-lg mb-2">SECTOR: CASSIOPEIA</h4>
                <p class="text-xs text-gray-400 leading-relaxed">
                    [STATUS: STABLE]<br>
                    COORDS: 01h 19m / +59°<br>
                    OBJECTS: Schedar, Caph<br>
                    NOTES: Possible site for deep space relay.
                </p>
            </div>
            <div class="map-text-box">
                <h4 class="text-blue-400 font-bold text-lg mb-2">SECTOR: URSA MAJOR</h4>
                <p class="text-xs text-gray-400 leading-relaxed">
                    [STATUS: OBSERVED]<br>
                    COORDS: 10h 40m / +55°<br>
                    OBJECTS: Merak, Dubhe<br>
                    SCAN: Multiple exoplanets in goldilocks zone.
                </p>
            </div>
        </div>
    </div>

    <div id="game-container" tabindex="0" class="outline-none">
        <div class="mb-3 text-blue-400 font-mono text-xs sm:text-sm flex flex-wrap gap-3 justify-center">
            <span>PILOT THE PROBE: [WASD] OR [ARROWS]</span>
            <span id="live-score" class="text-white">DISTANCE: 0 LY</span>
        </div>
        <canvas id="game-canvas" width="600" height="400"></canvas>
        <!-- Мобильные кнопки управления -->
        <div class="mobile-controls">
            <button class="ctrl-btn up" data-dir="up" aria-label="up">▲</button>
            <button class="ctrl-btn left" data-dir="left" aria-label="left">◀</button>
            <button class="ctrl-btn down" data-dir="down" aria-label="down">▼</button>
            <button class="ctrl-btn right" data-dir="right" aria-label="right">▶</button>
        </div>
        <button onclick="closeGame()" class="mt-4 border border-red-500 px-4 py-2 text-red-500 hover:bg-red-500 hover:text-white font-mono text-xs uppercase transition-colors">
            [ Abort Mission ]
        </button>
    </div>

    <div id="space-view" onclick="event.stopPropagation();">
        <div class="telemetry-overlay">
            <h3 id="mode-title" class="text-base sm:text-lg font-bold border-b border-blue-500 mb-2">SCANNER_V3</h3>
            <div id="telemetry-content" class="text-[10px] sm:text-[11px] leading-loose"></div>
        </div>
        <div id="three-canvas"></div>
        <div class="absolute bottom-5 right-5 sm:bottom-10 sm:right-10">
            <button onclick="closeDive()" class="px-4 py-2 sm:px-8 sm:py-3 border border-red-500 text-red-500 font-mono text-xs hover:bg-red-500 hover:text-white rounded-full uppercase">[ Disconnect ]</button>
        </div>
    </div>

    <div id="voyager-modal" class="fixed inset-0 hidden items-center justify-center bg-black/80 z-[7000] p-4" onclick="closeVoyagerLog();">
        <div class="voyager-box bg-[#020816] border border-blue-500 p-5 w-full max-w-md font-mono text-blue-400" onclick="event.stopPropagation()">
            <div class="flex justify-between border-b border-blue-900 pb-2 mb-3">
                <span>FILE: VOYAGER.log</span>
                <button onclick="closeVoyagerLog()">[ X ]</button>
            </div>
            <div id="voyager-log-content" class="text-xs mb-4"></div>
            <button onclick="startGame()" class="w-full border border-blue-500 py-2 hover:bg-blue-500/20 text-xs uppercase">[ Manual Override: Play Test ]</button>
        </div>
    </div>

    <div id="cursor"></div>
    <div id="coords">TRK: 0.000 / 0.000</div>
    <div id="starfield"></div>

    <section class="relative h-[35vh] sm:h-[45vh] flex flex-col items-center justify-center text-center px-4">
        <div class="animate-pulse mb-3 text-blue-400 tracking-[0.3em] text-[10px] uppercase">Orbital System Active</div>
        <h1 class="text-5xl sm:text-7xl md:text-8xl font-black italic tracking-tighter uppercase leading-none mb-4">
            Orbital <span class="clickable-word" onclick="event.stopPropagation(); openVoyagerLog();">Explorer</span>
        </h1>
        <p id="hero-type" class="text-gray-400 max-w-lg mx-auto tracking-widest text-xs font-mono"></p>
    </section>

    <section class="relative z-10 py-8 px-4 flex flex-wrap justify-center gap-6 pb-24">
        <div class="glass p-6 sm:p-10 w-full max-w-md sm:max-w-lg" onclick="event.stopPropagation(); diveIntoNebula();">
            <div class="card-img-container">
                <div class="scanline"></div>
                <img src="https://images.unsplash.com/photo-1462331940025-496dfbfc7564?auto=format&fit=crop&w=800">
            </div>
            <h2 class="text-2xl sm:text-4xl font-black uppercase mb-3 text-blue-400">Туманности</h2>
            <p class="text-gray-400 text-xs sm:text-sm mb-4">Анализ облака частиц NEBULA-G7.</p>
            <div class="text-[10px] text-blue-300 font-bold animate-pulse">[ АНАЛИЗИРОВАТЬ ]</div>
        </div>

        <div class="glass p-6 sm:p-10 w-full max-w-md sm:max-w-lg" onclick="event.stopPropagation(); diveIntoSpace();">
            <div class="card-img-container">
                <div class="scanline"></div>
                <img src="https://images.unsplash.com/photo-1614728894747-a83421e2b9c9?auto=format&fit=crop&w=800">
            </div>
            <h2 class="text-2xl sm:text-4xl font-black uppercase mb-3 text-purple-400">Экзопланеты</h2>
            <p class="text-gray-400 text-xs sm:text-sm mb-4">Исследование объекта K-186F с кольцевой системой.</p>
            <div class="text-[10px] text-purple-300 font-bold animate-pulse">[ ИССЛЕДОВАТЬ ]</div>
        </div>
    </section>

    <div id="cmd-terminal" onclick="event.stopPropagation();">
        <span class="text-blue-500 font-bold">CMD></span>
        <input type="text" id="cmd-input" placeholder="Type /play, /status, /clear..." autocomplete="off">
    </div>

    <script>
        const cursor = document.getElementById('cursor');
        const coords = document.getElementById('coords');
        const alertContainer = document.getElementById('alert-container');
        let scene, camera, renderer, currentObject, planetRing, stars, nebulaParticles, audioEnabled = false;

        // --- ЛОГИКА МИНИ-ИГРЫ (ОБНОВЛЕННАЯ С АДАПТИВНЫМ CANVAS И ТАЧ-УПРАВЛЕНИЕМ) ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        let gameActive = false;
        let player = { x: 50, y: 200, size: 20, speed: 6 };
        let asteroids = [];
        let score = 0;
        let keys = {};
        let gameLoopId;

        // --- ОБРАБОТЧИКИ ДЛЯ МОБИЛЬНЫХ КНОПОК ---
        function setupMobileControls() {
            const ctrlUp = document.querySelector('.ctrl-btn.up');
            const ctrlDown = document.querySelector('.ctrl-btn.down');
            const ctrlLeft = document.querySelector('.ctrl-btn.left');
            const ctrlRight = document.querySelector('.ctrl-btn.right');

            // Функция обновления состояния клавиш (только если игра активна)
            function setKey(code, state, e) {
                if (e) e.preventDefault(); // предотвращаем действия браузера
                if (gameActive) {
                    keys[code] = state;
                }
            }

            // Touch события
            ctrlUp.addEventListener('touchstart', (e) => setKey('ArrowUp', true, e));
            ctrlUp.addEventListener('touchend', (e) => setKey('ArrowUp', false, e));
            ctrlUp.addEventListener('touchcancel', (e) => setKey('ArrowUp', false, e));

            ctrlDown.addEventListener('touchstart', (e) => setKey('ArrowDown', true, e));
            ctrlDown.addEventListener('touchend', (e) => setKey('ArrowDown', false, e));
            ctrlDown.addEventListener('touchcancel', (e) => setKey('ArrowDown', false, e));

            ctrlLeft.addEventListener('touchstart', (e) => setKey('ArrowLeft', true, e));
            ctrlLeft.addEventListener('touchend', (e) => setKey('ArrowLeft', false, e));
            ctrlLeft.addEventListener('touchcancel', (e) => setKey('ArrowLeft', false, e));

            ctrlRight.addEventListener('touchstart', (e) => setKey('ArrowRight', true, e));
            ctrlRight.addEventListener('touchend', (e) => setKey('ArrowRight', false, e));
            ctrlRight.addEventListener('touchcancel', (e) => setKey('ArrowRight', false, e));

            // Для отладки на десктопе (мышь)
            ctrlUp.addEventListener('mousedown', (e) => setKey('ArrowUp', true, e));
            ctrlUp.addEventListener('mouseup', (e) => setKey('ArrowUp', false, e));
            ctrlUp.addEventListener('mouseleave', (e) => setKey('ArrowUp', false, e));

            ctrlDown.addEventListener('mousedown', (e) => setKey('ArrowDown', true, e));
            ctrlDown.addEventListener('mouseup', (e) => setKey('ArrowDown', false, e));
            ctrlDown.addEventListener('mouseleave', (e) => setKey('ArrowDown', false, e));

            ctrlLeft.addEventListener('mousedown', (e) => setKey('ArrowLeft', true, e));
            ctrlLeft.addEventListener('mouseup', (e) => setKey('ArrowLeft', false, e));
            ctrlLeft.addEventListener('mouseleave', (e) => setKey('ArrowLeft', false, e));

            ctrlRight.addEventListener('mousedown', (e) => setKey('ArrowRight', true, e));
            ctrlRight.addEventListener('mouseup', (e) => setKey('ArrowRight', false, e));
            ctrlRight.addEventListener('mouseleave', (e) => setKey('ArrowRight', false, e));
        }

        // Вызываем после загрузки DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupMobileControls);
        } else {
            setupMobileControls();
        }

        // Обработка клавиатуры (оставляем как есть)
        window.addEventListener('keydown', e => { 
            if (gameActive && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space'].includes(e.code)) {
                e.preventDefault(); 
            }
            keys[e.code] = true; 
        });
        window.addEventListener('keyup', e => { keys[e.code] = false; });

        function startGame() {
            closeVoyagerLog();
            document.getElementById('star-map').style.display = 'none';
            document.getElementById('space-view').style.display = 'none';
            
            const container = document.getElementById('game-container');
            container.style.display = 'flex';
            container.focus();
            
            // Сброс состояния
            gameActive = true;
            score = 0;
            asteroids = [];
            player.x = 80;
            player.y = canvas.height / 2;
            
            cancelAnimationFrame(gameLoopId);
            gameLoop();
            spawnAlert("MANUAL PILOTING ENGAGED");
        }

        function updateGame() {
            if (!gameActive) return;

            // Управление (клавиши + мобильные кнопки уже влияют на keys)
            if ((keys['KeyW'] || keys['ArrowUp']) && player.y > player.size) player.y -= player.speed;
            if ((keys['KeyS'] || keys['ArrowDown']) && player.y < canvas.height - player.size) player.y += player.speed;
            if ((keys['KeyA'] || keys['ArrowLeft']) && player.x > player.size) player.x -= player.speed;
            if ((keys['KeyD'] || keys['ArrowRight']) && player.x < canvas.width - player.size) player.x += player.speed;

            document.getElementById('live-score').innerText = `DISTANCE: ${score * 100} LY`;

            let spawnChance = 0.05 + (score * 0.0005);
            if (Math.random() < Math.min(spawnChance, 0.2)) {
                asteroids.push({
                    x: canvas.width + 50,
                    y: Math.random() * canvas.height,
                    size: 10 + Math.random() * 30,
                    speed: 4 + Math.random() * (score / 20)
                });
            }

            for (let i = asteroids.length - 1; i >= 0; i--) {
                let ast = asteroids[i];
                ast.x -= ast.speed;

                if (ast.x < -50) {
                    asteroids.splice(i, 1);
                    score++;
                    continue;
                }

                let dx = player.x - ast.x;
                let dy = player.y - ast.y;
                let distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < (player.size/2 + ast.size/2) * 0.8) {
                    endGame();
                }
            }
        }

        function drawGame() {
            ctx.fillStyle = '#000814';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = 'rgba(59, 130, 246, 0.1)';
            for(let i = 0; i < canvas.width; i+=40) {
                ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, canvas.height); ctx.stroke();
            }

            asteroids.forEach(ast => {
                ctx.fillStyle = '#475569';
                ctx.beginPath();
                ctx.arc(ast.x, ast.y, ast.size / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#64748b';
                ctx.stroke();
            });

            ctx.shadowBlur = 15;
            ctx.shadowColor = '#60a5fa';
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.size / 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        function gameLoop() {
            if (!gameActive) return;
            updateGame();
            drawGame();
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function endGame() {
            gameActive = false;
            spawnAlert("CRITICAL FAILURE: PROBE DESTROYED");
            spawnAlert("FINAL DATA RECOVERED: " + (score * 100) + " LY");
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            setTimeout(closeGame, 1500);
        }

        function closeGame() {
            gameActive = false;
            cancelAnimationFrame(gameLoopId);
            document.getElementById('game-container').style.display = 'none';
            // Сбрасываем клавиши, чтобы зонд не двигался после закрытия
            keys = {};
        }

        // --- ОСТАЛЬНЫЕ СИСТЕМНЫЕ ФУНКЦИИ ---
        function spawnAlert(msg) {
            const alert = document.createElement('div');
            alert.className = 'alert-box';
            alert.innerHTML = `<strong class="text-white">NASA UPLINK</strong><br/>> ${msg || "Система стабильна."}`;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function openVoyagerLog() {
            document.getElementById('voyager-modal').classList.remove('hidden');
            document.getElementById('voyager-modal').classList.add('flex');
            typeWriter("voyager-log-content", "> Voyager 1: Выход за пределы гелиосферы...\n> Дистанция: 24 млрд км.\n> Статус: Обнаружен зашифрованный сигнал.");
        }
        function closeVoyagerLog() { document.getElementById('voyager-modal').classList.add('hidden'); }

        function initThree() {
            if (renderer) return; 
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('three-canvas').appendChild(renderer.domElement);
            
            scene.add(new THREE.AmbientLight(0x404040, 2));
            const light = new THREE.PointLight(0xffffff, 2);
            light.position.set(20, 20, 20);
            scene.add(light);

            const starGeo = new THREE.BufferGeometry();
            const starMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.1 });
            const starPos = [];
            for (let i = 0; i < 8000; i++) {
                starPos.push((Math.random() - 0.5) * 1500, (Math.random() - 0.5) * 1500, (Math.random() - 0.5) * 1500);
            }
            starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
            stars = new THREE.Points(starGeo, starMat);
            scene.add(stars);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (currentObject) currentObject.rotation.y += 0.005;
            if (planetRing) planetRing.rotation.z += 0.002;
            if (nebulaParticles) nebulaParticles.rotation.y += 0.001;
            if (stars) stars.rotation.y += 0.0001;
            if (renderer) renderer.render(scene, camera);
        }

        function diveIntoSpace() {
            initThree();
            document.getElementById('space-view').style.display = 'block';
            clear3D();
            const pGeo = new THREE.SphereGeometry(5, 64, 64);
            const pMat = new THREE.MeshStandardMaterial({ color: 0x050505, roughness: 0.4, metalness: 0.8 });
            currentObject = new THREE.Mesh(pGeo, pMat);
            scene.add(currentObject);
            const rGeo = new THREE.RingGeometry(7, 11, 64);
            const rMat = new THREE.MeshBasicMaterial({ color: 0x887766, side: THREE.DoubleSide, transparent: true, opacity: 0.5 });
            planetRing = new THREE.Mesh(rGeo, rMat);
            planetRing.rotation.x = Math.PI / 2.5;
            scene.add(planetRing);
            camera.position.z = 20;
            typeWriter("telemetry-content", "OBJECT: K-186F\nТИП: ЭКЗОПЛАНЕТА\nКЛАСС: СУПЕРЗЕМЛЯ\nСТАТУС: СКАНИРОВАНИЕ...");
        }

        function diveIntoNebula() {
            initThree();
            document.getElementById('space-view').style.display = 'block';
            clear3D();
            const particleCount = 15000;
            const geo = new THREE.BufferGeometry();
            const positions = [], colors = [];
            const color = new THREE.Color();
            for (let i = 0; i < particleCount; i++) {
                positions.push((Math.random() - 0.5) * 45, (Math.random() - 0.5) * 45, (Math.random() - 0.5) * 45);
                const mixedColor = Math.random();
                if (mixedColor > 0.6) color.setHex(0xff00ff); 
                else if (mixedColor > 0.3) color.setHex(0x4400ff); 
                else color.setHex(0xaa00ff); 
                colors.push(color.r, color.g, color.b);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            const mat = new THREE.PointsMaterial({ size: 0.12, vertexColors: true, transparent: true, opacity: 0.7 });
            nebulaParticles = new THREE.Points(geo, mat);
            scene.add(nebulaParticles);
            camera.position.z = 30;
            typeWriter("telemetry-content", "OBJECT: NEBULA-G7\nОТДАЛЕННОСТЬ: 7.4A9320\nСОСТАВ: ВОДОРОД, ГЕЛИЙ\nИЗЛУЧЕНИЕ: КРИТИЧЕСКОЕ");
        }

        function clear3D() {
            if (currentObject) scene.remove(currentObject);
            if (planetRing) scene.remove(planetRing);
            if (nebulaParticles) scene.remove(nebulaParticles);
            currentObject = null; planetRing = null; nebulaParticles = null;
        }

        function closeDive() { document.getElementById('space-view').style.display = 'none'; }
        function showStarMap() { document.getElementById('star-map').style.display = 'block'; }
        function closeStarMap() { document.getElementById('star-map').style.display = 'none'; }

        function triggerGlitch() {
            document.body.classList.add('glitch-active');
            setTimeout(() => document.body.classList.remove('glitch-active'), 150);
        }

        function typeWriter(id, text) {
            let i = 0; const el = document.getElementById(id); el.innerHTML = "";
            function type() {
                if (i < text.length) {
                    el.innerHTML += (text.charAt(i) === '\n' ? '<br>' : text.charAt(i));
                    i++; setTimeout(type, 30);
                }
            }
            type();
        }

        function toggleAudio() {
            const m = document.getElementById('bg-music');
            audioEnabled ? m.pause() : m.play();
            audioEnabled = !audioEnabled;
            document.getElementById('audio-btn').innerText = audioEnabled ? "[ AUDIO: ON ]" : "[ AUDIO: OFF ]";
        }

        document.addEventListener('mousemove', (e) => {
            cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px';
            coords.innerText = `TRK: ${(e.clientX/window.innerWidth).toFixed(3)} / ${(e.clientY/window.innerHeight).toFixed(3)}`;
            coords.style.left = (e.clientX + 20) + 'px'; coords.style.top = (e.clientY + 20) + 'px';
        });

        document.getElementById('cmd-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const val = this.value.toLowerCase();
                this.value = '';
                if (val === '/status') spawnAlert("ALL SYSTEMS NOMINAL");
                else if (val === '/play') startGame();
                else if (val === '/clear') alertContainer.innerHTML = '';
            }
        });

        setInterval(() => { document.getElementById('mission-clock').innerText = new Date().toLocaleTimeString('en-GB'); }, 1000);
        window.onload = () => typeWriter("hero-type", "NASA TERMINAL v8.9 // СВЯЗЬ УСТАНОВЛЕНА // ГОТОВ К РАБОТЕ");

        function resizeGameCanvas() {
            if (canvas) {
                canvas.width = 600;
                canvas.height = 400;
            }
        }
        window.addEventListener('resize', resizeGameCanvas);
        resizeGameCanvas();
    </script>
</body>
</html>